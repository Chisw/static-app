<!DOCTYPE html>
<html>
<head>
<title>Tetris-é¸¡å“¥JavaScriptç‰ˆä¿„ç½—æ–¯æ–¹å—-å¥‡æ–¯å¨å…‹</title>
<meta http-equiv="content-type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=480, maximum-scale=1.0, user-scalable=0">
<style>

@font-face {
	font-family: 'digital';
	src: url('./digital.woff2') format('woff');
}

* {
	margin: 0;
	padding: 0;
	outline: none;
	text-decoration: none;
}
body {
	background: #555;
	min-height: 700px;
	overflow: hidden;
}



#title {
	position: absolute;
	top: 12px;
	left: 50%;
	margin-left: -50px;
	width: 100px;
	color: #fff;
	font-size: 16px;
	z-index: 2;
	background: #555;
	text-align: center;
	font-family: "å¾®è½¯é›…é»‘";
}


#screen {
	position: absolute;
	top: 36px;
	left: 50%;
	margin-left: -153px;
	width: 300px;
	height: 344px;
	background: #899775;
	border: 3px solid #333;
	border-right-color: #9D9D9D;
	border-bottom-color: #9D9D9D;
	border-radius: 5px;
	box-shadow: inset 0 0 6px #000;
	outline: 4px solid #393939;
	outline-offset: 10px;
}

#grid_box {
	position: absolute;
	top: 10px;
	left: 10px;
	width: 162px;
	height: 322px;
	border: 1px solid #000;
	border-radius: 2px;
	overflow: hidden;
}

#grid {
	position: absolute;
	bottom: 1px;
	left: 1px;
	width: 160px;
	height: 384px;
}

#next i,
#grid i {
	display: block;
	width: 14px;
	height: 14px;
	background: #899775;
	border: 1px solid #838D72;
	border-radius: 2px;
	float: left;
}

#next i::after,
#grid i::after {
	content: '';
	display: block;
	width: 12px;
	height: 12px;
	margin: 1px;
	background: #838D72;
	border-radius: 2px;
}

#next i.on,
#grid i.on { border: 1px solid #000; }

#next i.on::after,
#grid i.on::after { background: #000; }

#grid_top i,
#grid_top i.on,
#grid_top i::after,
#grid_top i.on::after {
	border: 1px solid #899775;
	background: none;
}



#info {
	position: absolute;
	top: 10px;
	right: 10px;
	width: 110px;
	height: 322px;
	font-family: 'digital';
}

#info p {
	text-align: right;
	font-size: 28px;
	height: 24px;
	margin-bottom: 4px;
}
#info p.info_title {font-size: 20px;font-style: italic;height: 20px;margin: 0;color: #838D72;}
#info p.info_title.on {color:#000;}

#info p span {
	position: absolute;
	right: 0;
}

#info p span.bg {
	/*position: relative;*/
	color: #838D72;
}

#next {
	position: absolute;
	top: 200px;
	right: 16px;
	width: 64px;
}


#music,
#coffee {
	position: absolute;
	right: 0;
	bottom: 0;
	opacity: .2;
	font-size: 36px;
}

#music {right: 58px;}

#music.on,#coffee.on {opacity: 1;}



#btns {
	position: absolute;
	top: 420px;
	left: 50%;
	width: 432px;
	margin-left: -216px;
	height: 240px;
}


.btn_dir,
#btn_enter {
	position: absolute;
	background: #00aef0;
	border: 2px solid #3B2C1A;
	box-shadow: 0 0 3px #444, 4px 4px 6px #444;
	background-image: -webkit-linear-gradient(90deg, #ff6600,#ff9900);
	color: #fff;
}

.btn_dir:active,
#btn_enter:active {
	box-shadow: 0 0 3px #444, inset 0 0 4px #222;
}

.btn_dir:active i,
#btn_enter:active i {
	font-size: 19px;
}



.btn_dir::before,
#btn_enter::before {
	content: '';
	display: block;
	position: absolute;
	top: 8%;
	left: 8%;
	width: 84%;
	height: 84%;
	border-radius: 50%;
	background-image: -webkit-linear-gradient(0deg, #ff7700,#ff8800);
}

.btn_dir:active::before,
#btn_enter:active::before {
	top: 9%;
	left: 9%;
	width: 82%;
	height: 82%;	
}

.btn_dir i,
#btn_enter i {
	position: absolute;
	top: 50%;
	left: 50%;
	display: block;
	font-size: 20px;
	margin-top: -12px;
	margin-left: -12px;
	width: 24px;
	height: 24px;
	text-align: center;
	line-height: 24px;
	z-index: 2;
	font-style: normal;
}

.btn_dir {
	width: 80px;
	height: 80px;
	border-radius: 80px;
}



#btn_top   {top: 0;  left: 80px;}
#btn_right {top: 80px; left: 160px;}
#btn_btm   {top: 160px; left: 80px;}
#btn_left  {top: 80px; left: 0;}

#btn_enter {
	top: 80px;
	right: 0;
	width: 136px;
	height: 136px;
	border-radius: 148px;
}

.btn_o {
	position: absolute;
	top: 0;
	width: 48px;
	height: 24px;
	line-height: 24px;
	background: #C6C6C6;
	border-radius: 12px;
	border: 1px solid #003B52;
	color: #fff;
	background-image: -webkit-linear-gradient(90deg, #0084B8,#00AEF0);
	box-shadow: 0 0 3px #444, 2px 2px 3px #444;
	text-align: center;
}
.btn_o:active {
	box-shadow: 0 0 3px #444, inset 0 0 4px #222;
}

#btn_o_ox    {right: 192px;}
#btn_o_bgm    {right: 128px;}
#btn_o_pause {right: 64px;}
#btn_o_menu  {right: 0;}



#mask,
#mask_mask,
#mask_load {
	position: fixed;
	top: 0;
	right: 0;
	bottom: 0;
	left: 0;
	background: rgba(0,0,0,.52);
	display: none;
	z-index: 5;
}

#mask_load {
	display: block;
	z-index: 4;
	background: #393A3F;
}

#loadbar {
	position: absolute;
	left: 50%;
	bottom: 20%;
	margin-left: -150px;
	width: 300px;
	height: 2px;
	background: #808080;
}
#loadbar p {
	width: 0;
	height: 100%;
	background: #0f0;
}



#menu {
	position: absolute;
	top: 100px;
	left: 50%;
	margin-left: -192px;
	width: 388px;
	background: #fff;
	border-radius: 4px;
	overflow: hidden;
	display: none;
	z-index: 5;
	font-family: "å¾®è½¯é›…é»‘";
}

#menu li {
	height: 64px;
	line-height: 64px;
	list-style: none;
	padding-left: 20px;
	border-bottom: 1px solid #d9d9d9;
}

#menu li:active {background: #eee;}

#menu li i {
	width: 32px;
	text-align: center;
}

#menu li span {
	float: right;
	margin-right: 24px;
	color: #888;
}

#ml_bomb_val {
	font-size: 24px;
}




#ajax {
	position: absolute;
	top: 20px;
	bottom: 20px;
	left: 50%;
	margin-left: -220px;
	width: 440px;
	background: #fff;
	border-radius: 4px;
	overflow: hidden;
	display: none;
	z-index: 6;	
	font-family: "å¾®è½¯é›…é»‘";
}

#ajax_in {
	position: absolute;
	top: 0;
	right: 0;
	bottom: 0px;
	left: 0;
	padding: 24px;
	overflow: hidden;
	overflow-y: scroll;
	padding-bottom: 72px;
}

#ajax_ox {
	position: absolute;
	bottom: 0;
	width: 100%;
	height: 58px;
	line-height: 58px;
	background: rgba(200,200,200,.9);
	text-align: center;
	font-size: 24px;
}

#ajax_ox:active {background: rgba(100,100,100,.9)}

#ajax table {font-size: 12px; margin-top: 12px; width: 100%; border-collapse: collapse;}
#ajax table tr {line-height: 24px;}
#ajax table tr:nth-child(odd) {background: #efefef;}
#ajax table tr.dlog_title {background: #aaa; padding: 2px; color: #fff;}
#ajax table tr.dlog_title .dlog_date {text-align: right;}

#ajax table tr td:nth-child(1) {text-align: center;}
#ajax table tr.dlog_title td {padding: 0 8px;}

#en_test { margin-top: 12px; font-size:14px;}
#en_test span {color: #808080;font-size:12px;line-height: 28px;}
#en_test b {font-size:16px;}
#en_test i {color: #FFC900;}

#ajax p {font-size: 14px; text-indent: 28px;margin: 8px;text-align: justify;}


#copyright {
	position: absolute;
	bottom: 8px;
	width: 100%;
	color: #888;
	text-align: center;
	font-size: 12px;
	text-shadow: 1px 1px 0 #333;
	z-index: 4;
	font-family: "å¾®è½¯é›…é»‘";
}


#toast {
	position:fixed;
	top:-100px;
	left:50%;
	margin-left:-210px;
	width:420px;
	box-sizing:border-box;
	border-radius:8px;
	padding:20px 10px;
	background:rgba(0,0,0,.9);
	color:#fff;
	text-align:center;
	font-size:16px;
	line-height: 24px;
	opacity:0;
	transition: .32s;
	z-index:9;
	font-family: "å¾®è½¯é›…é»‘";
}
#toast.on {top:20px;opacity:0.9;}

</style>
</head>
<body>

	<h1 id="title">JiTetris</h1>

	<div id="screen">
		<div id="grid_box">
			<div id="grid">
				<div id="grid_top">
				<i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
				</div>
				<i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
			</div>
		</div>

		<div id="info">

			<p class="info_title">SCORE</p>
			<p>
				<span class="bg">8888888</span>
				<span id="score"></span>
			</p>

			<p class="info_title">HI-SCORE</p>
			<p>
				<span class="bg">8888888</span>
				<span id="score_hi"></span>
			</p>

			<p class="info_title">LEVEL</p>
			<p>
				<span class="bg">88/88</span>
				<span id="level"></span>
			</p>

			<p class="info_title">SPEED</p>
			<p>
				<span class="bg">88</span>
				<span id="speed"></span>
			</p>

			<div id="next">
				<i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i>
				<i></i><i></i><i></i><i></i>
			</div>

			<div id="music">ğŸ”ˆ</div>
			<div id="coffee">â˜•ï¸</div>

		</div>

	</div>

	<div id="btns">
		<div class="btn_dir" id="btn_top"><i>â–²</i></div>
		<div class="btn_dir" id="btn_right"><i>â–¶ï¸</i></div>
		<div class="btn_dir" id="btn_btm"><i>â–¼</i></div>
		<div class="btn_dir" id="btn_left"><i>â—€ï¸</i></div>

		<div id="btn_enter"><i>â—</i></div>

		<div class="btn_o" id="btn_o_ox"> ğŸ•¹</div>
		<div class="btn_o" id="btn_o_bgm"> ğŸ”ˆ</div>
		<div class="btn_o" id="btn_o_pause"> â˜•ï¸</div>
		<div class="btn_o" id="btn_o_menu"> ğŸ“œ</div>

	</div>


	<div id="mask"></div>
	<div id="mask_mask"></div>


	<ul id="menu">
		<li id="ml_user">ç©å®¶æ˜µç§°<span id="ml_user_val">æœªå¡«å†™</span></li>
		<li id="ml_bomb">ç‚¸è£‚æ¨¡å¼<span id="ml_bomb_val">ğŸ”´</span></li>
	</ul>

	<div id="ajax">
		<div id="ajax_in"></div>
		<i id="ajax_ox">âŒ</i>
	</div>



	<div id="toast"></div>

	<div id="mask_load">
		<div id="loadbar"><p id="loadbars"></p></div>
	</div>

	<div id="copyright">Â© 2014-2017 Jisuowei.com</div>


</body>
<script src="https://apps.bdimg.com/libs/jquery/2.1.1/jquery.min.js"></script>
<script>


var gridArr = [
	[0,0,0,0,0,0,0,0,0,0],
	[0,0,0,0,0,0,0,0,0,0],
	[0,0,0,0,0,0,0,0,0,0],
	[0,0,0,0,0,0,0,0,0,0],
	[0,0,0,0,0,0,0,0,0,0],
	[0,0,0,0,0,0,0,0,0,0],
	[0,0,0,0,0,0,0,0,0,0],
	[0,0,0,0,0,0,0,0,0,0],
	[0,0,0,0,0,0,0,0,0,0],
	[0,0,0,0,0,0,0,0,0,0],
	[0,0,0,0,0,0,0,0,0,0],
	[0,0,0,0,0,0,0,0,0,0],
	[0,0,0,0,0,0,0,0,0,0],
	[0,0,0,0,0,0,0,0,0,0],
	[0,0,0,0,0,0,0,0,0,0],
	[0,0,0,0,0,0,0,0,0,0],
	[0,0,0,0,0,0,0,0,0,0],
	[0,0,0,0,0,0,0,0,0,0],
	[0,0,0,0,0,0,0,0,0,0],
	[0,0,0,0,0,0,0,0,0,0],
	[0,0,0,0,0,0,0,0,0,0],
	[0,0,0,0,0,0,0,0,0,0],
	[0,0,0,0,0,0,0,0,0,0],
	[0,0,0,0,0,0,0,0,0,0]
];


// @func: åˆ·æ–°ä¸‹ä¸€ä¸ª mover çš„æç¤º
// @param arr: ä¸‹ä¸€ä¸ª mover çš„ç‚¹æ•°ç»„ 4*4
function updateNext(arr) {
	for(var i=0; i<16; i++) {
		if(arr[i]) {
			$($('#next i')[i]).addClass('on');
		} else {
			$($('#next i')[i]).removeClass('on');
		}			
	}
}

// @func: åˆ·æ–°è§†å›¾å±‚
// @param arr: æ›´æ–°çš„å…¨å±€çš„ gridArr 24*10
function updateGrid(arr) {
	for(var i=0; i<24; i++) {
		for(var j=0; j<10; j++) {
			var num = parseInt('' + i + j);  // è·å–ç´¢å¼•ï¼Œå› ä¸º i å…ƒç´ å¹¶æ²¡æœ‰è¡Œå’Œåˆ—ï¼Œåªæœ‰0-239çš„ä¸‹æ ‡
			if(arr[i][j]) {  // åˆ¤æ–­æ˜¾ç¤ºè¿˜æ˜¯éšè—
				$($('#grid i')[num]).addClass('on');
			} else {
				$($('#grid i')[num]).removeClass('on');
			}
		}
	}
}


// @func: åˆ·æ–° mover çš„æ˜¾ç¤º
// @param ox:  0|1 , æ¸…é™¤åŸæœ‰ç‚¹|ç»˜åˆ¶ç°æœ‰ç‚¹
// @remark: åœ¨è°ƒç”¨ moveMover() ã€rotateMover() æ”¹å˜ mover çš„æ˜¾ç¤ºæ—¶ç”¨åˆ°
// @remark: setMover(0) å’Œ setMover(1) äºŒè€…ä¼šè¿ç”¨ï¼ŒäºŒè€…é—´ä¼šè¿›è¡Œ mover.pos çš„è®¡ç®—ä¿®æ”¹
// @remark: äºŒè€…é—´çš„è®¡ç®—æœªå¿…ä¼šæ”¹å˜ mover.posï¼Œæ¯”å¦‚æ—‹è½¬æ¡ä»¶ä¸è¾¾æ ‡
// @remark: äºŒè€…çš„è°ƒç”¨å¹¶ä¸ä¼šæ”¹å˜ mover.pos çš„å€¼ï¼Œè€Œæ˜¯å»ä¿®æ”¹äº†å¯¹åº” gridArr ä¸­ç‚¹çš„çŠ¶æ€ï¼ˆ0|1ï¼‰
function setMover(ox) {
	var arr = mover.pos;
	for(var i=0; i<arr.length; i++) {
		var row = arr[i][0];
		var col = arr[i][1];
		gridArr[row][col] = ox;
	}
	updateGrid(gridArr);
}




// åˆå§‹åŒ–
var isRun = false; // æ˜¯å¦å¼€æœº
var score = 0;     // å¾—åˆ†
var speed = 400;   // é€Ÿåº¦
var timer = null;  // å®šæ—¶å™¨
var music = false;
var isPau = false;

var ratio = {
	val: 19,
	score: 100,
	on: function(){
		this.val = 23;
		this.score = 200;
	},
	off: function(){
		this.val = 19;
		this.score = 100;
	}
};

var next  = Math.floor(Math.random()*ratio.val);

var ck_game_user = getCookie('game_user');
var ck_game_te_xbomb = getCookie('game_te_xbomb');


var timer_toast;
function toast(str, time) {
	var time = time*1000 || 3000;
	clearTimeout(timer_toast);
	$('#toast').html(str).addClass('on');
	timer_toast = setTimeout(function(){
		$('#toast').removeClass('on');
	}, time);
}


window.onload = function() {

	var loading = 0;
	timer_bar = setInterval(function(){
		var num = parseInt(Math.random()*10);
		$('#loadbars').width((loading+=num)*3);
		if(loading>88) {
			clearInterval(timer_bar);
			$('#loadbars').width(300);
			$('#mask_load').fadeOut(240);

			// æ£€æµ‹æ˜µç§°
			var str = '';
			if(!ck_game_user) {  // ä¸å­˜åœ¨
				str += 'Hiï¼Œä½ è¿˜æ²¡æœ‰æ˜µç§°å“¦ï¼<br>é˜ä¸‹çš„å¾—åˆ†å°†æ— æ³•è¿›å…¥æ’è¡Œæ¦œ';
			} else {  // å­˜åœ¨
				str += 'æ¬¢è¿å›æ¥ï¼Œå°Šæ•¬çš„ '+ decodeURIComponent(ck_game_user);
				$('#ml_user_val').text(decodeURIComponent(ck_game_user));
			}
			// ç‚¸è£‚æ¨¡å¼æ£€æµ‹
			if(ck_game_te_xbomb) {  // å¼€å¯
				$('#ml_bomb_val').html('ğŸŸ¢');
				str += '<br>ç‚¸è£‚æ¨¡å¼å·²å¼€å¯';
				ratio.on();
			} else {  // å…³é—­
				$('#ml_bomb_val').html('ğŸ”´');
				str += '<br>ç‚¸è£‚æ¨¡å¼æœªå¼€å¯';
				ratio.off();
			}
			toast(str, 3);

			// console.log('ratio.val: '+ ratio.val + ', ratio.score: '+ ratio.score);
		}
	}, 120);

}




/* å½¢çŠ¶é›†åˆ
[
	{
		"eval": {            // å¯æ‰§çš„ string
			"shape": 'L',    // å­—å½¢ J|L|S|Z|T|I|O
			"dir": 1,        // æœå‘ 1|2|3|4
			"pos": [],       // åˆå§‹ä½ç½®
		},
		"next": []           // åœ¨ #next ä¸­çš„å½¢æ€
	},
]
*/
var movers = [
	{"eval":"mover = { shape: 'L', dir: 1, pos: [ [0,5],[1,5],[2,5],[2,6] ] }", "next":[0,1,0,0,0,1,0,0,0,1,1,0,0,0,0,0]},
	{"eval":"mover = { shape: 'L', dir: 2, pos: [ [1,5],[1,6],[1,7],[2,5] ] }", "next":[0,1,1,1,0,1,0,0,0,0,0,0,0,0,0,0]},
	{"eval":"mover = { shape: 'L', dir: 3, pos: [ [1,5],[1,6],[2,6],[3,6] ] }", "next":[0,1,1,0,0,0,1,0,0,0,1,0,0,0,0,0]},
	{"eval":"mover = { shape: 'L', dir: 4, pos: [ [2,7],[3,5],[3,6],[3,7] ] }", "next":[0,0,1,0,1,1,1,0,0,0,0,0,0,0,0,0]},

	{"eval":"mover = { shape: 'T', dir: 1, pos: [ [1,5],[2,4],[2,5],[2,6] ] }", "next":[0,0,1,0,0,1,1,1,0,0,0,0,0,0,0,0]},
	{"eval":"mover = { shape: 'T', dir: 2, pos: [ [0,5],[1,5],[1,6],[2,5] ] }", "next":[0,0,1,0,0,0,1,1,0,0,1,0,0,0,0,0]},
	{"eval":"mover = { shape: 'T', dir: 3, pos: [ [1,4],[1,5],[1,6],[2,5] ] }", "next":[0,0,0,0,0,1,1,1,0,0,1,0,0,0,0,0]},
	{"eval":"mover = { shape: 'T', dir: 4, pos: [ [0,5],[1,4],[1,5],[2,5] ] }", "next":[0,0,1,0,0,1,1,0,0,0,1,0,0,0,0,0]},

	{"eval":"mover = { shape: 'O', dir: 1, pos: [ [1,4],[1,5],[2,4],[2,5] ] }", "next":[0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0]},

	{"eval":"mover = { shape: 'J', dir: 1, pos: [ [0,5],[1,5],[2,4],[2,5] ] }", "next":[0,0,1,0, 0,0,1,0, 0,1,1,0, 0,0,0,0]},
	{"eval":"mover = { shape: 'J', dir: 2, pos: [ [1,4],[2,4],[2,5],[2,6] ] }", "next":[0,1,0,0, 0,1,1,1, 0,0,0,0, 0,0,0,0]},
	{"eval":"mover = { shape: 'J', dir: 3, pos: [ [0,4],[0,5],[1,4],[2,4] ] }", "next":[0,1,1,0, 0,1,0,0, 0,1,0,0, 0,0,0,0]},
	{"eval":"mover = { shape: 'J', dir: 4, pos: [ [0,4],[0,5],[0,6],[1,6] ] }", "next":[0,1,1,1, 0,0,0,1, 0,0,0,0, 0,0,0,0]},

	{"eval":"mover = { shape: 'S', dir: 1, pos: [ [0,4],[1,4],[1,5],[2,5] ] }", "next":[0,1,0,0, 0,1,1,0, 0,0,1,0, 0,0,0,0]},
	{"eval":"mover = { shape: 'S', dir: 2, pos: [ [1,5],[1,6],[2,4],[2,5] ] }", "next":[0,0,1,1, 0,1,1,0, 0,0,0,0, 0,0,0,0]},

	{"eval":"mover = { shape: 'Z', dir: 1, pos: [ [0,5],[1,4],[1,5],[2,4] ] }", "next":[0,0,1,0, 0,1,1,0, 0,1,0,0, 0,0,0,0]},
	{"eval":"mover = { shape: 'Z', dir: 2, pos: [ [1,4],[1,5],[2,5],[2,6] ] }", "next":[0,1,1,0, 0,0,1,1, 0,0,0,0, 0,0,0,0]},

	{"eval":"mover = { shape: 'I', dir: 1, pos: [ [0,5],[1,5],[2,5],[3,5] ] }", "next":[0,0,1,0, 0,0,1,0, 0,0,1,0, 0,0,1,0]},
	{"eval":"mover = { shape: 'I', dir: 2, pos: [ [2,3],[2,4],[2,5],[2,6] ] }", "next":[0,0,0,0, 1,1,1,1, 0,0,0,0, 0,0,0,0]},

	{"eval":"mover = { shape: 'V', dir: 1, pos: [ [1,3],[1,6],[2,4],[2,5] ] }", "next":[0,0,0,0, 1,0,0,1, 0,1,1,0, 0,0,0,0]},

	{"eval":"mover = { shape: 'W', dir: 1, pos: [ [1,4],[1,6],[2,3],[2,5] ] }", "next":[0,1,0,1, 1,0,1,0, 0,0,0,0, 0,0,0,0]},

	{"eval":"mover = { shape: 'X', dir: 1, pos: [ [0,3],[0,5],[2,3],[2,5] ] }", "next":[0,1,0,1, 0,0,0,0, 0,1,0,1, 0,0,0,0]},

	{"eval":"mover = { shape: 'Y', dir: 1, pos: [ [0,3],[0,5],[1,4],[2,3] ] }", "next":[0,1,0,1, 0,0,1,0, 0,1,0,0, 0,0,0,0]},


];


/* é™æ€å¼•ç”¨
"rt": {          // å³æç‚¹
	"i": 1,      // å³æç‚¹ä¸‹æ ‡
	"tgt": []    // å³æç‚¹å¾…éšœæ£€ç‚¹æ•°ç»„
},
"bt": {          // åº•æç‚¹
	"i": 1,
	"tgt": []
},
"lt": {          // å·¦æç‚¹
	"i": 1,
	"tgt": []
}
"trans": {       // è´´è¾¹æ˜¯å¦éœ€è¦å¹³ç§»
	"hor": -1,   // -1|0|1    å·¦å¹³ç§»|ä¸å¹³ç§»|å³å¹³ç§»
	"tgt": []    // å¹³ç§»å¾…éšœæ£€ç‚¹æ•°ç»„
},
"btmout": 1,     // æ˜¯å¦éœ€è¦æ£€æµ‹åº•è¾¹ 0|1
"rtd": 4,        // æ—‹è½¬åçš„æœå‘ 1|2|3|4
"rotate": {      // æ—‹è½¬ç›¸å…³
	"check": [{base: , row: , col: },],  // æ—‹è½¬éšœæ£€ç‚¹ç›¸å¯¹ä½ç½®   {åŸºç‚¹ä¸‹æ ‡, æ°´å¹³åç§»ï¼Œå‚ç›´åç§»}
	"move":  [{base: , row: , col: },]   // æ—‹è½¬éœ€è¦æ›´æ”¹çš„ç‚¹     {åŸºç‚¹ä¸‹æ ‡, æ°´å¹³åç§»ï¼Œå‚ç›´åç§»}
}
*/
var static = {
	'L': {
		'1':{ 'rt': { 'i': 3, 'tgt': [0,1,3]}, 'bt': { 'i': 3, 'tgt': [2,3]},   'lt': { 'i': 0, 'tgt': [0,1,2]}, 'trans':{ 'hor':-1, 'tgt':[0,1,2]}, 'btmout':0, 'rtd':2, 'rotate':{ 'check':[ {'base': 0, 'row': 0, 'col': 1},{'base': 0, 'row': 0, 'col': 2}], 'move':[ {'base': 1, 'row':-1, 'col': 1}, {'base': 2, 'row':-2, 'col': 2}, {'base': 3, 'row':-1, 'col':-1}] } },
		'2':{ 'rt': { 'i': 2, 'tgt': [2,3]},   'bt': { 'i': 3, 'tgt': [1,2,3]}, 'lt': { 'i': 0, 'tgt': [0,3]} ,  'trans':{ 'hor': 0, 'tgt':[]},      'btmout':1, 'rtd':3, 'rotate':{ 'check':[ {'base': 2, 'row': 1, 'col': 0},{'base': 2, 'row': 2, 'col': 0}], 'move':[ {'base': 0, 'row': 0, 'col': 1}, {'base': 1, 'row': 0, 'col': 1}, {'base': 2, 'row': 1, 'col': 0}, {'base': 3, 'row':  1, 'col': 2}] } },
		'3':{ 'rt': { 'i': 1, 'tgt': [1,2,3]}, 'bt': { 'i': 3, 'tgt': [0,3]},   'lt': { 'i': 0, 'tgt': [0,2,3]}, 'trans':{ 'hor': 1, 'tgt':[1,2,3]}, 'btmout':0, 'rtd':4, 'rotate':{ 'check':[ {'base': 3, 'row': 0, 'col':-1},{'base': 3, 'row': 0, 'col':-2}], 'move':[ {'base': 0, 'row': 1, 'col': 1}, {'base': 1, 'row': 2, 'col':-2}, {'base': 2, 'row': 1, 'col':-1}] } },
		'4':{ 'rt': { 'i': 0, 'tgt': [0,3]},   'bt': { 'i': 3, 'tgt': [1,2,3]}, 'lt': { 'i': 1, 'tgt': [0,1]} ,  'trans':{ 'hor': 0, 'tgt':[]},      'btmout':0, 'rtd':1, 'rotate':{ 'check':[ {'base': 1, 'row':-1, 'col':-2},{'base': 1, 'row':-2, 'col': 0}], 'move':[ {'base': 0, 'row':-1, 'col':-2}, {'base': 1, 'row':-1, 'col': 0}, {'base': 2, 'row': 0, 'col':-1}, {'base': 3, 'row': 0, 'col':-1,}] } }
	},
	'T': {
		'1':{ 'rt': { 'i': 3, 'tgt': [0,3]},   'bt': { 'i': 3, 'tgt': [1,2,3]}, 'lt': { 'i': 1, 'tgt': [0,1]} ,  'trans':{ 'hor': 0, 'tgt':[]},      'btmout':1, 'rtd':2, 'rotate':{ 'check':[ {'base': 0, 'row': 2, 'col': 0}], 'move':[ {'base': 0, 'row': 0, 'col': 0}, {'base': 1, 'row': 0, 'col': 1}, {'base': 2, 'row': 0, 'col': 1}, {'base': 3, 'row': 1, 'col':-1}] } },
		'2':{ 'rt': { 'i': 2, 'tgt': [0,2,3]}, 'bt': { 'i': 3, 'tgt': [2,3]},   'lt': { 'i': 0, 'tgt': [0,1,3]}, 'trans':{ 'hor': 1, 'tgt':[0,1,3]}, 'btmout':0, 'rtd':3, 'rotate':{ 'check':[ {'base': 1, 'row': 0, 'col':-1}], 'move':[ {'base': 0, 'row': 1, 'col':-1}] } },
		'3':{ 'rt': { 'i': 2, 'tgt': [2,3]},   'bt': { 'i': 3, 'tgt': [0,2,3]}, 'lt': { 'i': 0, 'tgt': [0,3]} ,  'trans':{ 'hor': 0, 'tgt':[]},      'btmout':1, 'rtd':4, 'rotate':{ 'check':[ {'base': 1, 'row':-1, 'col': 0}], 'move':[ {'base': 0, 'row':-1, 'col': 1}, {'base': 1, 'row': 0, 'col':-1}, {'base': 2, 'row': 0, 'col':-1}] } },
		'4':{ 'rt': { 'i': 0, 'tgt': [0,2,3]}, 'bt': { 'i': 3, 'tgt': [1,3]},   'lt': { 'i': 1, 'tgt': [0,1,3]}, 'trans':{ 'hor':-1, 'tgt':[0,2,3]}, 'btmout':0, 'rtd':1, 'rotate':{ 'check':[ {'base': 2, 'row': 0, 'col': 1}], 'move':[ {'base': 3, 'row':-1, 'col': 1}] } }
	},
	'O': {
		'1':{ 'rt': { 'i': 1, 'tgt': [1,3]},   'bt': { 'i': 2, 'tgt': [2,3]},   'lt': { 'i': 0, 'tgt': [0,2]},   'trans':{ 'hor': 0} , 'rotate':0 }
	},
	'J': {
		'1':{ 'rt': { 'i': 0, 'tgt': [0,1,3]}, 'bt': { 'i':2, 'tgt': [2,3]}, 'lt': { 'i':2, 'tgt': [0,1,2]} ,  'trans':{ 'hor': 1, 'tgt':[0,1,3]}, 'btmout':0, 'rtd':2, 'rotate':{ 'check':[ {'base':2, 'row': 0, 'col':-1},{'base':2, 'row':-1, 'col':-1}], 'move':[ {'base':0, 'row': 1, 'col':-2}, {'base':1, 'row': 1, 'col':-2}] } },
		'2':{ 'rt': { 'i': 3, 'tgt': [0,3]},   'bt': { 'i':1, 'tgt': [1,2,3]}, 'lt': { 'i':0, 'tgt': [0,1]} ,  'trans':{ 'hor': 0, 'tgt':[]},      'btmout':0, 'rtd':3, 'rotate':{ 'check':[ {'base':0, 'row':-1, 'col': 0},{'base':0, 'row':-1, 'col': 1}], 'move':[ {'base':0, 'row':-1, 'col': 0}, {'base':1, 'row':-2, 'col': 1}, {'base':2, 'row':-1, 'col':-1}, {'base':3, 'row': 0, 'col':-2}] } },
		'3':{ 'rt': { 'i': 1, 'tgt': [1,2,3]}, 'bt': { 'i':3, 'tgt': [1,3]},  'lt': { 'i':0, 'tgt': [0,2,3]} , 'trans':{ 'hor':-1, 'tgt':[0,2,3]}, 'btmout':0, 'rtd':4, 'rotate':{ 'check':[ {'base':1, 'row': 0, 'col': 1},{'base':1, 'row': 1, 'col': 1}], 'move':[ {'base':2, 'row':-1, 'col': 2}, {'base':3, 'row':-1, 'col': 2}] } },
		'4':{ 'rt': { 'i': 2, 'tgt': [2,3]},   'bt': { 'i':3, 'tgt': [0,1,3]}, 'lt': { 'i':0, 'tgt': [0,3]} ,  'trans':{ 'hor': 0, 'tgt':[]},      'btmout':1, 'rtd':1, 'rotate':{ 'check':[ {'base':3, 'row': 1, 'col': 0},{'base':3, 'row': 1, 'col':-1}], 'move':[ {'base':0, 'row': 0, 'col': 2}, {'base':1, 'row': 1, 'col': 1}, {'base':2, 'row': 2, 'col':-1}, {'base':3, 'row': 1, 'col': 0}] } }
		},
	'S': {
		'1':{ 'rt': { 'i': 2, 'tgt': [0,2,3]}, 'bt': { 'i':3, 'tgt': [1,3]}, 'lt': { 'i':0, 'tgt': [0,1,3]} ,  'trans':{ 'hor':-1, 'tgt':[0,1,3]}, 'btmout':0, 'rtd':2, 'rotate':{ 'check':[ {'base':1, 'row': 1, 'col': 0},{'base':2, 'row': 0, 'col': 1}], 'move':[ {'base':0, 'row': 1, 'col': 1}, {'base':1, 'row': 0, 'col': 2}, {'base':2, 'row': 1, 'col':-1}] } },
		'2':{ 'rt': { 'i': 1, 'tgt': [1,3]},   'bt': { 'i':2, 'tgt': [1,2,3]}, 'lt': { 'i':2, 'tgt': [0,2]} ,  'trans':{ 'hor': 0, 'tgt':[]},      'btmout':0, 'rtd':1, 'rotate':{ 'check':[ {'base':0, 'row': 0, 'col':-1},{'base':0, 'row':-1, 'col':-1}], 'move':[ {'base':0, 'row':-1, 'col':-1}, {'base':1, 'row': 0, 'col':-2}, {'base':2, 'row':-1, 'col': 1}] } },
		},
	'Z': {
		'1':{ 'rt': { 'i': 0, 'tgt': [0,2,3]}, 'bt': { 'i':3, 'tgt': [2,3]}, 'lt': { 'i':1, 'tgt': [0,1,3]} ,  'trans':{ 'hor':-1, 'tgt':[0,2,3]}, 'btmout':0, 'rtd':2, 'rotate':{ 'check':[ {'base':3, 'row': 0, 'col': 1},{'base':3, 'row': 0, 'col': 2}], 'move':[ {'base':0, 'row': 1, 'col':-1}, {'base':1, 'row': 0, 'col': 1}, {'base':2, 'row': 1, 'col': 0}, {'base':3, 'row': 0, 'col': 2}] } },
		'2':{ 'rt': { 'i': 3, 'tgt': [1,3]},   'bt': { 'i':2, 'tgt': [0,2,3]}, 'lt': { 'i':0, 'tgt': [0,2]} ,  'trans':{ 'hor': 0, 'tgt':[]},      'btmout':0, 'rtd':1, 'rotate':{ 'check':[ {'base':0, 'row':-1, 'col': 1},{'base':0, 'row': 1, 'col': 0}], 'move':[ {'base':0, 'row':-1, 'col': 1}, {'base':1, 'row': 0, 'col':-1}, {'base':2, 'row':-1, 'col': 0}, {'base':3, 'row': 0, 'col':-2}] } },
		},
	'I': {
		'1':{ 'rt': { 'i': 0, 'tgt': [0,1,2,3]}, 'bt': { 'i':3, 'tgt': [3]}, 'lt': { 'i':0, 'tgt': [0,1,2,3]} ,  'trans':{ 'hor': 2, 'tgt':[0,1,2,3]}, 'btmout':0, 'rtd':2, 'rotate':{ 'check':[ {'base':2, 'row': 0, 'col':-2},{'base':2, 'row': 0, 'col':-1},{'base':2, 'row': 0, 'col': 1}], 'move':[ {'base':0, 'row': 2, 'col':-2}, {'base':1, 'row': 1, 'col':-1}, {'base':3, 'row':-1, 'col': 1}] } },
		'2':{ 'rt': { 'i': 3, 'tgt': [3]},   'bt': { 'i':0, 'tgt': [0,1,2,3]}, 'lt': { 'i':0, 'tgt': [0]} ,'trans':{ 'hor': 0, 'tgt':[]},        'btmout':1, 'rtd':1, 'rotate':{ 'check':[ {'base':2, 'row':-2, 'col': 0},{'base':2, 'row':-1, 'col': 0},{'base':2, 'row': 1, 'col': 0}], 'move':[ {'base':0, 'row':-2, 'col': 2}, {'base':1, 'row':-1, 'col': 1}, {'base':3, 'row': 1, 'col':-1}] } },
		},
	'V': {
		'1':{ 'rt': { 'i': 1, 'tgt': [1,3]},   'bt': { 'i': 2, 'tgt': [0,1,2,3]},   'lt': { 'i': 0, 'tgt': [0,2]},   'trans':{ 'hor': 0} , 'rotate':0 }
	},
	'W': {
		'1':{ 'rt': { 'i': 1, 'tgt': [1,3]},   'bt': { 'i': 2, 'tgt': [0,1,2,3]},   'lt': { 'i': 2, 'tgt': [0,2]},   'trans':{ 'hor': 0} , 'rotate':0 }
	},
	'X': {
		'1':{ 'rt': { 'i': 1, 'tgt': [1,3]},   'bt': { 'i': 2, 'tgt': [2,3]},   'lt': { 'i': 0, 'tgt': [0,2]},   'trans':{ 'hor': 0} , 'rotate':0 }
	},
	'Y': {
		'1':{ 'rt': { 'i': 1, 'tgt': [1,2,3]},  'bt': { 'i': 3, 'tgt': [1,2,3]},   'lt': { 'i': 0, 'tgt': [0,2,3]},   'trans':{ 'hor': 0} , 'rotate':0 }
	},

}


// var nextArr = [
// 	0,1,1,0,
// 	0,1,1,0,
// 	0,0,0,0,
// 	0,0,0,0];
// updateNext(nextArr);
// console.log(nextArr.toString());


function newMover() {

	clearInterval(timer);

	eval(movers[next].eval);  // new mover
	// eval(movers[22].eval);  // new mover test
	// eval(movers[8]);

	next = Math.floor(Math.random()*ratio.val);  // éšæœºç”Ÿäº§ mover
	updateNext(movers[next].next);  // update next

	timer = setInterval(function(){
		moveMover(3);
	}, speed);

}




// è™šæ‹ŸæŒ‰é”®æ§åˆ¶
$('#btn_top'  ).click(function(){ rotateMover(); });
$('#btn_right').click(function(){ moveMover(2);  });
$('#btn_btm'  ).click(function(){ moveMover(3);  });
$('#btn_left' ).click(function(){ moveMover(4);  });
$('#btn_enter').click(function(){ rotateMover(); });


//  é”®ç›˜æ–¹å‘é”®æ§åˆ¶
document.onkeydown = function(event) {
	var key = event.keyCode;
	switch (key) {
		case 37: moveMover(4);  break;
		case 38: rotateMover(); break;
		case 39: moveMover(2);  break;
		case 40: moveMover(3);  break;
	}
}



// ç”µæºé”®
$('#btn_o_ox').click(function(){
	if(isRun) {  // å…³æœºæ“ä½œ

		$('#music,#coffee').removeClass('on');
		
		$('.info_title').removeClass('on');
		$('#score, #score_hi, #level, #speed').text('');

		clearInterval(timer);
		// grid æ¸…é›¶
		for(var i=0; i<24; i++) {
			for( var j=0; j<10; j++) {
				gridArr[i][j] = 0;
			}
		}
		updateGrid(gridArr);

		isRun = false;

		// next æ¸…é›¶
		for(var i=0; i<16; i++) {
			$($('#next i')).removeClass('on');
		}

		// é‡ç½®
		score = 0;
		speed = 600;
		timer = null;
		music = false;
		isPau = false;
		mover = null;

	} else {  // å¼€æœºæ“ä½œ

		toast('æ¸¸æˆå¼€å§‹ï¼', 0.8);

		var hisco = getCookie('game_te_hisco');
		hisco ? hisco : hisco = 0;

		// console.log(hisco);
		
		$('.info_title').addClass('on');
		$('#score').text('0');
		$('#score_hi').text(hisco);
		$('#level').text('1/20');
		$('#speed').text('1');

		newMover();
		isRun = true;
	}
});


// éŸ³æ•ˆé”®
$('#btn_o_bgm').click(function(){
	if(isRun) {  // å¼€æœºæ‰èƒ½æ§åˆ¶éŸ³æ•ˆ
		if(music) {  // å…³é—­
			$('#music').removeClass('on');
			music = false;
		} else {  // å¼€å¯
			$('#music').addClass('on');
			music = true;
		}
	}
});


// æš‚åœé”®
$('#btn_o_pause').click(function(){
	if(isRun) {  // å¼€æœºæ‰èƒ½æš‚åœ
		if(isPau) {  // é‡æ–°å¼€å§‹
			$('#coffee').removeClass('on');

			toast('æ¸¸æˆç»§ç»­ï¼', 1);

			timer = setInterval(function(){
				moveMover(3);
			}, speed);

			isPau = false;
		} else {  // æš‚åœ

			$('#coffee').addClass('on');

			toast('æ¸¸æˆå·²ç»æš‚åœï¼', 3);

			clearInterval(timer);

			isPau = true;
		}
	}
});



// èœå•é”®
$('#btn_o_menu').click(function(){
	if(!isRun || (isRun && isPau) ) {  // æœªå¼€æœº || å¼€æœºå·²ç»æš‚åœ
		$('#mask,#menu').fadeIn(240);
	} else {
		toast('å½“å‰æ¸¸æˆæ­£åœ¨è¿è¡Œä¸­<br>è¯·æš‚åœåå†è¯•');
	}
});


$('#mask').click(function(){
	$('#mask,#menu').fadeOut(240);
});

// ç©å®¶æ˜µç§°
$('#ml_user').click(function(){
	var hint = '';
	if(ck_game_user) {
		hint = decodeURIComponent(ck_game_user);
	}

	var name = prompt('å¹¸ä¼šï¼Œæ•¢é—®é˜ä¸‹å°Šå§“å¤§åï¼šé•¿åº¦ä¸è¦è¶…è¿‡12ä½ï¼Œéµå¾ªç½‘ç»œæ–‡æ˜å“Ÿ', hint);
	if(name) {
		if(name.match('åµ‡æ‰€ä¼Ÿ')) {
			name = 'åŒ…å«æ•æ„Ÿå­—ç¬¦';
		} else if(name.length > 12) {
			name = 'é•¿åº¦è¶…è¿‡12ä½';
		} else {
			// cookie
			setCookie('game_user', name, setCookieDate(30));
		}
		$('#ml_user_val').text(name);
		ck_game_user = name;
	}
});


// ç‚¸è£‚æ¨¡å¼
$('#ml_bomb').click(function(){
if(isRun) {
	toast('å½“å‰æ¸¸æˆæœªç»“æŸï¼Œè¯·å…³é—­æ¸¸æˆæœºåå†è¯•');
} else {

	if(ck_game_te_xbomb) {  // å…³é—­
		$('#ml_bomb_val').html('ğŸ”´');
		toast("æ€ä¹ˆäº†éªšå¹´ï¼Œä¸ºä»€ä¹ˆè¦æ”¾å¼ƒç‚¸è£‚æ¨¡å¼ï¼");
		setCookie('game_te_xbomb', '', setCookieDate(30));
		ratio.off();
		ck_game_te_xbomb = false;
	} else {  // å¼€å¯
		$('#ml_bomb_val').html('ğŸŸ¢');
		toast("æ­å–œæ‚¨ï¼ŒæˆåŠŸå¼€å¯ç‚¸è£‚æ¨¡å¼<br>å¾—åˆ†ç¿»å€ï¼Œèµ¶ç´§è¯•è¯•å§ï¼", 5);
		setCookie('game_te_xbomb', '1', setCookieDate(30));
		ratio.on();
		ck_game_te_xbomb = true;
	}

}
});

$('#ajax_ox').click(function(){
	$('#mask_mask,#ajax').fadeOut(240);
});




// @func: æ—‹è½¬ mover
function rotateMover() {
if(isRun && !isPau) {  // å¼€æœº ä¸” æ²¡æœ‰æš‚åœ

	setMover(0);
	var arr = mover.pos;

	var transDir = static[mover.shape][mover.dir].trans.hor;  // å¹³ç§»æ–¹å‘
	var transArr = static[mover.shape][mover.dir].trans.tgt;
	var isLt = arr[static[mover.shape][mover.dir].lt.i][1]==0;
	var isRt = arr[static[mover.shape][mover.dir].rt.i][1]==9;

	// console.log('left: '+ isLt + ', right: '+ isRt+ transDir);

	// å·¦è´´è¾¹ä¸”éœ€è¦å³ç§» æˆ–è€… å³è´´è¾¹éœ€è¦å·¦ç§» çš„æƒ…å†µè¿›è¡Œåç§»
	if(  ( isLt && transDir==1)  ||  ( isRt && transDir==-1) || ( transDir==2 && (isLt||isRt)  )  ) {
		if(transDir==2) {  // 'I' æƒ…å†µç‰¹æ®Š
			if(arr[static[mover.shape][mover.dir].rt.i][1]==9) {
				transDir = -1;
			}
		}

		var checkArr = [];  // å¹³ç§»æ¡ä»¶
		for(var i=0; i<transArr.length; i++) {
			var tempPoint = [];
			tempPoint[0] = arr[transArr[i]][0];  // å¹³ç§»è¡Œä¸å˜
			tempPoint[1] = arr[transArr[i]][1] + transDir;
			checkArr.push(tempPoint);
		}

		if(checkPoint(checkArr)) {
			for(var i=0; i<4; i++) {
				arr[i][1]+=transDir;
			}
		}

	}

	var rotate = static[mover.shape][mover.dir].rotate;

	if(rotate) {  // åˆ¤æ–­æ˜¯å¦éœ€è¦æ—‹è½¬ï¼Œæ¯”å¦‚ 'O' å½¢ä¸º0ï¼Œå°±ä¸éœ€è¦æ—‹è½¬
		var checkArrRt = [];  // æ—‹è½¬æ¡ä»¶
		for(var i=0; i<rotate.check.length; i++) {
			var tempPoint = [];
			tempPoint[0] = arr[rotate.check[i].base][0] + rotate.check[i].row;
			tempPoint[1] = arr[rotate.check[i].base][1] + rotate.check[i].col;
			checkArrRt.push(tempPoint);
		}

		// è§¦åº•æ—‹è½¬
		var exception = true;
		if(static[mover.shape][mover.dir].btmout) {
			exception = arr[static[mover.shape][mover.dir].bt.i][0] < 23;
		}
		if( exception && checkPoint(checkArrRt)) {  // æ—‹è½¬

			for(var i=0; i<rotate.move.length; i++) {
				arr[rotate.move[i].base][0] += rotate.move[i].row;
				arr[rotate.move[i].base][1] += rotate.move[i].col;
			}
			mover.dir = static[mover.shape][mover.dir].rtd;
		}
	}

	setMover(1);


} else if(isRun) {  // å¼€æœº ä¸” æ²¡æœ‰æš‚åœ
	toast('å¤§ä¾ æ‚¨çš„æ¸¸æˆå·²ç»æš‚åœäº†')
} else {
	toast('è¯·æŒ‰å¼€æœºé”®å¼€å§‹æ¸¸æˆ')
}
}



// @func: ä¼ å‚æ§åˆ¶ mover çš„ä½ç½®ï¼Œè¡Œ æ§åˆ¶ ä¸Šä¸‹ï¼Œ åˆ— æ§åˆ¶ å·¦å³
// @param dir:  2|3|4  è¿åŠ¨çš„æ–¹å‘ï¼Œå³|ä¸‹|å·¦ï¼Œéµå¾ª TRBL åŸåˆ™ï¼Œç”¨æ¥åˆ¤æ–­èƒ½å¦èƒ½æ‰§è¡Œè¿åŠ¨
function moveMover(dir) {
if(isRun && !isPau) {  // å¼€æœº ä¸” æ²¡æœ‰æš‚åœ

	var canMove = false;

	switch(dir) {
		case 2:  // to right
			if(mover.pos[static[mover.shape][mover.dir].rt.i][1] < 9) {  // æœªè¶…å‡ºå³è¾¹

				var checkArr = [];
				for(var i=0; i<static[mover.shape][mover.dir].rt.tgt.length; i++) {
					var tempPoint = [];
					tempPoint[0] = mover.pos[static[mover.shape][mover.dir].rt.tgt[i]][0];
					tempPoint[1] = mover.pos[static[mover.shape][mover.dir].rt.tgt[i]][1] + 1;
					checkArr.push(tempPoint);
				}

				if(checkPoint(checkArr)) { canMove = true; }

			}
		break;

		case 3:  // to bottm
			if(mover.pos[static[mover.shape][mover.dir].bt.i][0] < 23) {  // æœªè¶…å‡ºåº•è¾¹

				var checkArr = [];
				for(var i=0; i<static[mover.shape][mover.dir].bt.tgt.length; i++) {
					var tempPoint = [];
					tempPoint[0] = mover.pos[static[mover.shape][mover.dir].bt.tgt[i]][0] + 1;
					tempPoint[1] = mover.pos[static[mover.shape][mover.dir].bt.tgt[i]][1];
					checkArr.push(tempPoint);
				}

				if(checkPoint(checkArr)) { canMove = true; } else { checkScore(); }

			} else { checkScore(); }
		break;

		case 4:  // to left
			if(mover.pos[static[mover.shape][mover.dir].lt.i][1] > 0) {  // æœªè¶…å‡ºå·¦è¾¹

				var checkArr = [];
				for(var i=0; i<static[mover.shape][mover.dir].lt.tgt.length; i++) {
					var tempPoint = [];
					tempPoint[0] = mover.pos[static[mover.shape][mover.dir].lt.tgt[i]][0];
					tempPoint[1] = mover.pos[static[mover.shape][mover.dir].lt.tgt[i]][1] - 1;
					checkArr.push(tempPoint);
				}

				if(checkPoint(checkArr)) { canMove = true; }
			}
		break;
	}

	if(canMove) {
		setMover(0);

		switch(dir) {
			case 2:  // å³
				for(var i=0; i<4; i++) {
					mover.pos[i][1] += 1;
				}
			break;

			case 3:  // ä¸‹
				for(var i=0; i<4; i++) {
					mover.pos[i][0] += 1;
				}
			break;

			case 4: // å·¦
				for(var i=0; i<4; i++) {
					mover.pos[i][1] -= 1;
				}
			break;
		}

		setMover(1);
	}

} else if(isRun) {  // å¼€æœº ä¸” æ²¡æœ‰æš‚åœ
	toast('å¤§ä¾ æ‚¨çš„æ¸¸æˆå·²ç»æš‚åœäº†')
} else {
	toast('è¯·æŒ‰å¼€æœºé”®å¼€å§‹æ¸¸æˆ')
}
}





// @func: æ ¹æ®ä¼ å…¥çš„ç‚¹åˆ¤æ–­è¯¥ç‚¹ä½æ˜¯å¦ä¸º0 å¹¶å–å
// @param arr: [row,col] ç‚¹çš„è¡Œä¸‹æ ‡ï¼Œåˆ—ä¸‹æ ‡
// function checkPoint(arr) {
// 	return !gridArr[arr[0]][arr[1]];
// }


// @func: æ ¹æ®ä¼ å…¥çš„ç‚¹åˆ¤æ–­è¯¥ç‚¹ä½æ˜¯å¦ä¸º0 å¹¶å–å
// @param arr: [row,col], ..  ç‚¹çš„ è¡Œä¸‹æ ‡ï¼Œåˆ—ä¸‹æ ‡
// function checkPoint() {
// 	var res = [];
// 	var len = arguments.length;
// 	for(var i=0; i<len; i++) {
// 		var is = ! gridArr[ arguments[i][0] ][ arguments[i][1] ];
// 		if(is) {
// 			res.push(is);
// 		}
// 	}
// 	// console.log('checkPoint: '+ res.length +'/'+ len);
// 	return res.length == len;
// }

// @func: æ ¹æ®ä¼ å…¥çš„æ•°ç»„ï¼ˆå¤šä¸ªç‚¹ï¼‰åˆ¤æ–­è¯¥ç‚¹ä½æ˜¯å¦ä¸º0 å¹¶å–å
// @param arr: [ [row,col], .. ] ç‚¹çš„ è¡Œä¸‹æ ‡ï¼Œåˆ—ä¸‹æ ‡
function checkPoint(arr) {
	var res = [];
	for(var i=0; i<arr.length; i++) {
		var is = ! gridArr[ arr[i][0] ][ arr[i][1] ];
		if(is) {
			res.push(is);
		}
	}
	// console.log('checkPoint: '+ res.length +'/'+ len);
	return res.length == arr.length;
}




// è§¦åº•å éå†å¾—åˆ† å¹¶æ¶ˆé™¤
function checkScore() {
	// console.log((new Date).getMilliseconds() +' fixed');
	var disArr = [];  // éœ€è¦æ¶ˆé™¤çš„è¡Œçš„ä¸‹æ ‡æ•°ç»„
	for(var i=0; i<24; i++) {  // éå†æ‰€æœ‰è¡Œ
		var num=0;  // å®å¿ƒä¸ªæ•°
		for(var j=0; j<10; j++) {  // éå†è¡Œä¸­æ‰€æœ‰ç‚¹
			if(gridArr[i][j]) {
				num++;  // å¦‚æœä¸º 1 å³ å®å¿ƒ å°±ç´¯åŠ 
			}
		}
		if(num==10) {  // 10ä¸ªå®å¿ƒ å°±ä¿å­˜è¯¥è¡Œåˆ°æ¶ˆé™¤é˜Ÿåˆ—
			disArr.push(i);
		}
		// console.log('å®å¿ƒä¸ªæ•° '+ num);
	}
	if(disArr.length) {  // é¿å…ç©ºè½¬
		// console.log('å®å¿ƒçš„è¡Œï¼š'+ disArr.length);
		// å®å¿ƒè¡Œç½®0
		for(var i=0; i<disArr.length; i++) {
			for(var j=0; j<10; j++) {
				gridArr[disArr[i]][j] = 0;  
			}
		}
		// ç©ºå‡ºéƒ¨åˆ†æ¶ˆé™¤ï¼Œæ€è·¯ï¼šå¾—åˆ°æ¶ˆé™¤è¡Œé˜Ÿåˆ—åï¼Œç”±ä¸Šè€Œä¸‹éå†ï¼Œæ¯æ¶ˆé™¤ä¸€è¡Œï¼Œä¾¿ç«‹å³æ•´ä½“å‘ä¸‹å¹³ç§»ä¸€è¡Œ
		// å‡è®¾æœ‰ä¸€è¡Œï¼šç¬¬15è¡Œï¼ˆ14ï¼‰è¯¥è¢«æ¶ˆé™¤
		for(var i=0; i<disArr.length; i++) {  // å‡è®¾ï¼šdisArr.length == 1

			var tempGridArr = [];  // ç¼“å­˜å®¹å™¨
			for(var j=4; j<disArr[i]; j++) {  // å‡è®¾ï¼šdisArr[i] == 14 ï¼Œéå†ä¿å­˜ 15ï¼ˆ14ï¼‰ä»¥ä¸Šæ•°æ®
				tempGridArr[j] = gridArr[j];
			}
			for(var j=4; j<disArr[i]; j++) {
				gridArr[j+1] = tempGridArr[j];  // å‘ä¸‹å¹³ç§»
			}

			gridArr[4] = [0,0,0,0,0,0,0,0,0,0];  // æ¯æ¬¡æ¶ˆè¡Œï¼ˆç¬é—´ï¼‰æ‰‹åŠ¨æ¸…ç©ºé¡¶è¡Œæ®‹ç•™ï¼ˆå¹³ç§»é€ æˆï¼‰
		}

		updateGrid(gridArr);

		// è®¡ç®—å¾—åˆ†
		score += disArr.length * ratio.score;
		$('#score').text(score);
	}

	// è§¦é¡¶æ£€æµ‹
	if(mover.pos[3][0]>4) {  // ç»§ç»­
		newMover();
	} else {  // æ¸¸æˆç»“æŸ
		clearInterval(timer);
		toast('Game Over');

		// è·å–å†å²æœ€é«˜åˆ†
		var hisco = getCookie('game_te_hisco') || 0;
		console.log('score='+score+' hisco='+hisco);
		if(score > hisco) {
			// è¶…è¿‡ï¼šæ›´æ–°cookie
			setCookie('game_te_hisco', score, setCookieDate(30));
			toast('æœ¬æ¬¡æ¸¸æˆæ‚¨è·å¾—äº† '+ score +' åˆ†');
		}

		// grid æ¸…é›¶
		for(var i=0; i<24; i++) {
			for( var j=0; j<10; j++) {
				gridArr[i][j] = 0;
			}
		}
		updateGrid(gridArr);

		isRun = false;

		// next æ¸…é›¶
		for(var i=0; i<16; i++) {
			$($('#next i')).removeClass('on');
		}

		// é‡ç½®
		score = 0;
		speed = 600;
		timer = null;
		isPau = false;
		mover = null;


	}
}


// cookie
function setCookie(name,value,expires,path,domain,secure) {
	var cookieName = encodeURIComponent(name) + '=' + encodeURIComponent(value);
	if(expires instanceof Date) { cookieName += ';expires=' + expires;}
	if(path) { cookieName += ';path=' + path;}
	if(domain) { cookieName += ';domain=' + domain;}
	if(secure) { cookieName += ';secure' }
	document.cookie = cookieName;
}

function setCookieDate(day) {
	var date = null;
	if ( typeof day == 'number' && day > 0 ) {
		date = new Date();
		date.setDate(date.getDate() + day);
	} else {
		throw new Error('æ‚¨è¾“å…¥çš„æ—¥æœŸä¸æ­£ç¡®');
	}
	return date;
}

function getCookie(name){
	var cookieName = encodeURIComponent(name) + '=';
	var cookieStart = document.cookie.indexOf(cookieName);
	var cookieValue = null;

	if(cookieStart > -1 ) {
		var cookieEnd = document.cookie.indexOf(';',cookieStart);
		if ( cookieEnd == -1 ){
			cookieEnd = document.cookie.length;
		}
		cookieValue = document.cookie.substring(cookieStart + cookieName.length, cookieEnd);
	}
	return cookieValue;
}

function delCookie(name){
	document.cookie = name +'='+ name +';expires=' + new Date(0);
}
</script>
</html>